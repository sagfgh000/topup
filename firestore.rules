rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if a user is an admin
    function isAdmin() {
      // Make sure to use your actual admin email address here
      return request.auth.token.email == 'kymt83091@gmail.com';
    }

    // Products can be read by anyone, but only managed by admins
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings can be read by anyone, but only managed by admins
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wallets:
    // - Users can create their own wallet (e.g. on signup/agreement)
    // - Users can read and UPDATE their own wallet (update is needed for placing orders)
    // - Admins can read/write any wallet
    match /wallets/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow list, delete: if isAdmin();
    }

    // Orders:
    // - Users can create their own orders
    // - Users can read their own orders
    // - Admins can read/write any order
    match /orders/{orderId} {
      allow read, write: if isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow list: if request.auth != null; // Allow logged-in users to list/query their own orders
    }
    
    // TopUpRequests:
    // - Users can create their own topup requests
    // - Users cannot read other's requests
    // - Admins can read/write any request
    match /topUpRequests/{requestId} {
      allow read, write: if isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow list: if request.auth != null; // Allow logged-in users to list/query their own topups
    }
  }
}
