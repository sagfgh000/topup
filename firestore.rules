rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }

    // Products can be read by anyone, but only written by an admin
    match /products/{productId} {
      allow read;
      allow write: if isAdmin();
    }

    // Wallets:
    // Users can create their own wallet document for the first time.
    // Users can update their own wallet (e.g. for placing an order).
    // Admin can read/write any wallet.
    match /wallets/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      allow update, set: if request.auth.uid == userId || isAdmin(); // set is needed for {merge: true}
    }
    
    // Settings can be read by anyone, but only written by an admin
    match /settings/{docId} {
      allow read;
      allow write: if isAdmin();
    }

    // Top-Up Requests:
    // Users can create their own requests.
    // Users can view their own requests.
    // Admin can read/write all requests.
    match /topUpRequests/{requestId} {
      allow read: if request.auth.uid == request.resource.data.userId || isAdmin();
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if isAdmin();
    }

    // Orders:
    // Anyone can read orders (for public tracking).
    // Users can only create orders for themselves with valid data.
    // Admin can update any order.
    match /orders/{orderId} {
      allow read;
      allow create: if request.auth.uid == request.resource.data.userId
                      && request.resource.data.status == 'Pending'
                      && request.resource.data.userEmail == request.auth.token.email;
      allow update: if isAdmin();
    }
  }
}
