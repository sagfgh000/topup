
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Wallets:
    // 1. Allow a user to create their own wallet document for the first time.
    // 2. Allow a user to update their own wallet (e.g., when an order deducts balance).
    // 3. Allow an admin to read any wallet for the customer list.
    match /wallets/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      // FIX: Allow both 'update' and 'set' (with merge) for balance changes.
      allow write: if request.auth.uid == userId; 
      
      function isAdmin() {
        return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
      }
    }
    
    // Orders:
    // 1. Users can create their own orders.
    // 2. Users can only read their own orders.
    // 3. Admins can read/write any order.
    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if isAdmin();
      
      function isAdmin() {
        return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
      }
    }
    
    // TopUpRequests:
    // 1. Users can create their own top-up requests.
    // 2. Users can't see other people's requests.
    // 3. Admins can see and update any request.
    match /topUpRequests/{requestId} {
       allow read: if request.auth.uid == resource.data.userId || isAdmin();
       allow create: if request.auth.uid == request.resource.data.userId;
       allow update: if isAdmin();

       function isAdmin() {
        return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
      }
    }

    // Products:
    // 1. Anyone can read the product list (for the homepage).
    // 2. Only admins can create, update, or delete products.
    match /products/{productId} {
        allow read: if true;
        allow write: if isAdmin();
        
        function isAdmin() {
          return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
        }
    }
    
    // Settings (for promo banner):
    // 1. Anyone can read the settings.
    // 2. Only admins can change the settings.
     match /settings/{settingId} {
        allow read: if true;
        allow write: if isAdmin();
        
        function isAdmin() {
          return request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
        }
    }
  }
}
