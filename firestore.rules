
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Wallets:
    // - Users can create their own wallet for the first time.
    // - Users can read their own wallet.
    // - Admins can do anything.
    // - Wallet updates for users are handled by transactions (see orders rule).
    match /wallets/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Admin override
      allow read, create, update, delete: if request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }

    // Orders:
    // - Users can create their own orders (and this transaction can update their wallet).
    // - Users can read their own orders.
    // - Admins can do anything.
    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId &&
                       // Ensure the wallet is being correctly debited in the same transaction
                       getAfter(/databases/$(database)/documents/wallets/$(request.auth.uid)).data.balance ==
                       get(/databases/$(database)/documents/wallets/$(request.auth.uid)).data.balance - request.resource.data.productPrice;

      // Admin override
      allow read, create, update, delete: if request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }

    // Products:
    // - Anyone can read the product list.
    // - Admins can manage products.
    match /products/{productId} {
      allow read;
      allow create, update, delete: if request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }

    // Top-Up Requests:
    // - Users can create their own requests.
    // - Users can read their own requests.
    // - Admins can do anything.
    match /topUpRequests/{requestId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;

      // Admin override
      allow read, create, update, delete: if request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }
    
    // Settings (e.g., promo banner):
    // - Only the admin can read or write.
    match /settings/{settingId} {
       allow read, write: if request.auth != null && request.auth.token.email == 'kymt83091@gmail.com';
    }
  }
}
